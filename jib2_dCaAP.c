#include <qpe.h>  // required qpe support functions
#include <nmu.h>  // neuromorphic accelerators

int main ()
{
  // define LUT
  static float AB_lookup[778] = {0.001,0.0010338261894701668,0.0010687941798160588,0.0011049423466620088,0.0011423103440239783,0.0011809391461111063,0.001220871090439867,0.0012621499222982635,0.00130482084059828,0.0013489305451556061,0.001394527285436431,0.001441660910811879,0.0014903829223614196,0.0015407465262673385,0.001592806688843085,0.0016466201932390213,0.001702245697869789,0.0017597437966081642,0.0018191770807908984,0.0018806102030826351,0.0019441099432445375,0.0020097452758547603,0.0020775874400283567,0.0021477100111845825,0.0022201889749099103,0.0022951028029652865,0.0023725325314863633,0.002452561841425503,0.0025352771412843495,0.00262076765218564,0.002709125495332686,0.002800445781904613,0.0028948267054349267,0.002992369636720341,0.0030931792213059815,0.003197363479592103,0.003305033909606268,0.003416305592483562,0.0035312973006958043,0.0036501316090688813,0.003772935008625206,0.0038998380232859392,0.004030975329464928,0.004166485878583298,0.004306513022530328,0.004451204642092461,0.004600713278368283,0.004755196267182692,0.004914815876508565,0.005079739446898735,0.005250139534925157,0.005426194059615611,0.0056080864518711976,0.0057960058068402326,0.005990147039215712,0.006190711041414551,0.006397904844586992,0.006611941782394024,0.00683304165747931,0.007061430910549862,0.007297342791966595,0.007541017535731756,0.007792702535745136,0.00805265252418479,0.008321129751850717,0.008598404170291481,0.008884753615514104,0.009180463993056586,0.00948582946418017,0.009801152632914716,0.010126744733665564,0.01046292581906351,0.010810024947711475,0.01116838037145162,0.01153833972174523,0.011920260194724582,0.012314508734441114,0.012721462213797533,0.013141507612613004,0.013575042192230144,0.014022473666030322,0.014484220365179566,0.014960711398881266,0.015452386808363833,0.015959697713781536,0.016483106453154903,0.017023086712423332,0.01758012364562708,0.018154713984178474,0.01874736613412335,0.019358600260233116,0.019988948355706023,0.02063895429619293,0.021309173876798662,0.022000174830644724,0.022712536827513424,0.023446851451027095,0.02420372215274993,0.024983764181533797,0.02578760448636415,0.026615881590897797,0.027469245437821657,0.028348357201101067,0.029253889064128274,0.030186523961727222,0.031146955283920193,0.03213588653931602,0.033154030975939344,0.03420211115728668,0.0352808584913683,0.03639101271047709,0.037533321299416424,0.03870853886992091,0.03991742647901685,0.041160750889095564,0.04243928376751224,0.043753800823578874,0.04510508088089118,0.046493904883019695,0.04792105483070425,0.04938731264882078,0.05089345898154135,0.0524402719142836,0.05402852562124506,0.05565898893754402,0.05733242385524051,0.05904958394279183,0.060811212687806385,0.06261804176329822,0.06447078921801444,0.06637015759180685,0.06831683195744982,0.07031147789076743,0.07235473937142348,0.07444723661724875,0.07658956385552777,0.07878228703524226,0.08102594148486825,0.08332102952094482,0.08566801801327358,0.08806733591326418,0.09051937175260988,0.09302447112015226,0.09558293412547328,0.09819501285842665,0.10086090885448737,0.103580770576448,0.1063546909236175,0.10918270478027636,0.11206478661570086,0.11500084814858301,0.11799073608913184,0.12103422997253815,0.12413104009780973,0.12728080558622942,0.1304830925738453,0.1337373925524633,0.13704312087356924,0.14039961542945475,0.14380613552555022,0.1472618609575753,0.15076589130659876,0.15431724546444975,0.15791486140114178,0.16155759618505802,0.16524422626560245,0.16897344802684913,0.1727438786194263,0.1765540570764574,0.1804024457178594,0.18428743184567398,0.1882073297313969,0.19216038289448362,0.19614476666936187,0.2001585910563907,0.20419990385028639,0.20826669403760928,0.21235689545298841,0.21646839068187607,0.2205990151957892,0.22474656170423066,0.2289087847058111,0.2330834052195289,0.23726811567573142,0.24146058494499356,0.2456584634820208,0.24985938856073373,0.25406098957592566,0.258260893386318,0.2624567296734738,0.2666461362908754,0.2708267645775315,0.2749962846107413,0.2791523903731237,0.28329280480969343,0.28741528475163736,0.2915176256844986,0.2955976663396998,0.29965329308971717,0.30368244412873624,0.30768311342226207,0.31165335441089864,0.31559128345534015,0.3194950830115059,0.32336300452668004,0.3271933710494708,0.3309845795483596,0.33473510293554276,0.33844349179467353,0.342108375812954,0.3447284649198075,0.34801916657159676,0.35118266412581123,0.3541954375913454,0.35702783811477834,0.35964243408255997,0.361991957182698,0.3640167783467913,0.3656418497426659,0.3667730718049556,0.36729309571525476,0.36705666973466766,0.3658858074398069,0.3635653289971049,0.3598397367718538,0.35441295522652977,0.3469531708439076,0.3371057320548273,0.3245175178258747,0.30887581213088644,0.2899627441045587,0.2677219897300487,0.24232755570353023,0.21423661516715425,0.18420345145160888,0.15323498144852937,0.12248341552930453,0.09309495547962565,0.06605373467993775,0.042064621903758204,0.021503003121290942,0.0044332695343939355,-0.00932447730488728,-0.020108427790143935,-0.028334038319348387,-0.034431482437639216,-0.038804986644655926,-0.04181120550254086,-0.04375138695716263,-0.04487214573330489,-0.045370805062803,-0.04540259165380456,-0.045088070006096825,-0.04451997810337105,-0.04376911443181042,-0.042889203885679406,-0.04192081084315902,-0.04089442674525062,-0.03983287369188926,-0.03875315748250352,-0.03766788613687316,-0.036586350169221515,-0.0355153421353544,-0.03445977663145516,-0.03342315835883153,-0.03240793494775035,-0.03141576261683915,-0.030447706040366396,-0.029504388630730738,-0.028586105492375002,-0.027692908296312158,-0.026824669044523075,-0.025981127969637474,-0.02516192951458207,-0.02436664935691102,-0.0235948147050567,-0.02284591953922177,-0.02211943605293404,-0.02141482323830962,-0.02073153332306049,-0.02006901659087501,-0.01942672498439424,-0.018804114790636317,-0.01820064863415649,-0.01761579694727039,-0.017049039044674308,-0.01649986389827829,-0.015967770684412352,-0.01545226915780401,-0.01495287989338867,-0.014469134426996766,-0.014000575318431296,-0.013546756154790007,-0.013107241507625544,-0.012681606854329008,-0.01226943847170675,-0.011870333307889003,-0.011483898837334361,-0.011109752902642156,-0.01074752354609304,-0.010396848833229333,-0.010057376670323803,-0.009728764617228325,-0.00941067969681686,-0.009102798202023199,-0.008804805501302915,-0.008516395843219615,-0.00823727216074227,-0.007967145875760029,-0.00770573670424618,-0.007452772462445356,-0.007207988874409987,-0.006971129381169283,-0.00674194495177699,-0.006520193896456972,-0.006305641682033125,-0.006098060749811618,-0.005897230336056769,-0.005702936295186256,-0.005514970925792839,-0.005333132799582918,-0.005157226593309805,-0.004987062923765384,-0.0048224581858825055,-0.0046632343939879695,-0.004509219026239408,-0.004360244872266605,-0.004216149884031795,-0.004076777029914713,-0.003941974152021799,-0.0038115938267135885,-0.0036854932283355013,-0.003563533996136403,-0.0034455821043503643,-0.0033315077354161837,-0.0032211851563028193,-0.003114492597907803,-0.003011312137490396,-0.0029115295841003475,-0.002815034366959568,-0.002721719426752478,-0.0026314811097794544,-0.00254421906492458,-0.0024598361433894045,-0.0023782383011420882,-0.0022993345040318025,-0.0022230366355154296,-0.0021492594069441595,-0.0020779202703586908,-0.002008939333738302,-0.0019422392786515585,-0.0018777452802555272,-0.0018153849295895474,-0.0017550881581115951,-0.001696787164424618,-0.0016404163431399943,-0.001585912215826324,-0.0015332133639933132,-0.0014822603640585186,-0.0014329957242483204,-0.0013853638233822796,-0.0013393108514930807,-0.001294784752233713,-0.001251735167024759,-0.0012101133808948283,-0.001169872269969563,-0.0011309662505630258,-0.0010933512298287318,-0.0010569845579264658,-0.0010218249816629221,-0.000987832599564642,-0.0009549688183435601,-0.0009231963107140251,-0.0008924789745240469,-0.0008627818931626341,-0.0008340712972054187,-0.0008063145272634853,-0.0007794799979998768,-0.0007535371632794718,-0.000728456482418316,-0.0007042093875004873,-0.0006807682517299685,-0.0006581063587871583,-0.0006361978731593276,-0.0006150178114158189,-0.0005945420143993463,-0.000574747120305863,-0.0005556105386249621,-0.00053711042491561,-0.0005192256563910647,-0.0005019358082874459,-0.00048522113099330744,-0.00046906252791478753,-0.00045344153405518783,-0.0004383402952851667,-0.0004237415482836737,-0.00040962860112708777,-0.00039598531450707464,-0.0003827960835575128,-0.00037004582027067023,-0.0003577199364848127,-0.0003458043274243705,-0.00033428535577584295,-0.00032314983628234373,-0.0003123850208394674,-0.00030197858407809974,-0.00029191860941696346,-0.0002821935755710214,-0.0002727923435009716,-0.00026370414378895646,-0.00025491856442816374,-0.00024642553901133013,-0.00023821533530737904,-0.00023027854421153737,-0.00022260606905821767,-0.00021518911528517481,-0.00020801918043639178,-0.0002010880444935359,-0.00019438776052566054,-0.00018791064564593896,-0.00018164927226588246,-0.0001755964596379389,-0.00016974526567614667,-0.00016408897904640618,-0.0001586211115172098,-0.00015333539056294754,-0.00014822575221073997,-0.0001432863341236934,-0.00013851146891213917,-0.0001338956776655298,-0.00012943366369866371,-0.0001251203065038009,-0.0001209506559028406,-0.00011691992639284443,-0.00011302349167868764,-0.0001092568793861215,-0.00010561576595041755,-0.0001020959716732106,-9.86934559438768e-05,-9.540431261839677e-05,-9.222476555192927e-05,-8.915116427860026e-05,-8.617997983523251e-05,-8.330780072257626e-05,-8.053132900109894e-05,-7.784737651594931e-05,-7.52528612471548e-05,-7.274480378050008e-05,-7.032032389603371e-05,-6.797663726904046e-05,-6.571105228142526e-05,-6.352096693773568e-05,-6.140386588465718e-05,-5.935731752865214e-05,-5.737897124952207e-05,-5.5466554706562476e-05,-5.361787123425721e-05,-5.183079732423712e-05,-5.010328019089405e-05,-4.843333541815209e-05,-4.681904468384346e-05,-4.525855356052322e-05,-4.375006938850401e-05,-4.2291859220278116e-05,-4.088224783255212e-05,-3.951961580506147e-05,-3.820239766305633e-05,-3.6929080081071763e-05,-3.5698200146927483e-05,-3.4508343683625764e-05,-3.335814362620537e-05,-3.2246278453440524e-05,-3.1171470671220725e-05,-3.0132485346723303e-05,-2.912812869082515e-05,-2.8157246688309545e-05,-2.7218723773203557e-05,-2.6311481548246807e-05,-2.5434477547048306e-05,-2.4586704037599105e-05,-2.3767186865142342e-05,-2.2974984334012127e-05,-2.2209186126442848e-05,-2.1468912257405215e-05,-2.075331206430331e-05,-2.0061563230311386e-05,-1.939287083985164e-05,-1.874646646621292e-05,-1.8121607288923425e-05,-1.7517575240599825e-05,-1.6933676182662172e-05,-1.6369239107971723e-05,-1.582361537011412e-05,-1.529617793866178e-05,-1.478632067891672e-05,-1.429345765574519e-05,-1.3817022460449468e-05,-1.3356467560288188e-05,-1.2911263669757034e-05,-1.2480899142242041e-05,-1.2064879382656102e-05,-1.1662726278893754e-05,-1.127397765304794e-05,-1.0898186730168291e-05,-1.0534921625227067e-05,-1.018376484668293e-05,-9.844312817086642e-06,-9.516175409507444e-06,-9.19897549905846e-06,-8.89234852985421e-06,-8.595942095956932e-06,-8.30941553664477e-06,-8.03243954516919e-06,-7.764695790002385e-06,-7.505876549296353e-06,-7.255684357554415e-06,-7.013831663460479e-06,-6.780040499587692e-06,-6.554042163153806e-06,-6.335576907046114e-06,-6.124393641504522e-06,-5.920249645685605e-06,-5.722910288552541e-06,-5.532148759257449e-06,-5.347745806960624e-06,-5.169489488143775e-06,-4.997174923748737e-06,-4.830604063310595e-06,-4.669585457528491e-06,-4.513934038385958e-06,-4.363470906099121e-06,-4.218023124058501e-06,-4.077423519599499e-06,-3.941510492100342e-06,-3.810127827463816e-06,-3.683124518150116e-06,-3.5603545901485845e-06,-3.4416769347789256e-06,-3.326955146820687e-06,-3.216057367583236e-06,-3.108856133360316e-06,-3.0052282291581633e-06,-2.9050545469200273e-06,-2.8082199485246484e-06,-2.7146131338362522e-06,-2.624126512418279e-06,-2.5366560800765825e-06,-2.4521012992329005e-06,-2.370364983461659e-06,-2.2913531856905145e-06,-2.214975090342186e-06,-2.1411429089734924e-06,-2.0697717791895442e-06,-2.000779667332697e-06,-1.934087274169105e-06,-1.8696179435173654e-06,-1.8072975745409003e-06,-1.7470545361497614e-06,-1.6888195850661702e-06,-1.63252578583295e-06,-1.5781084343746699e-06,-1.525504983168613e-06,-1.4746549695798805e-06,-1.4254999465279639e-06,-1.377983414818651e-06,-1.3320507588066022e-06,-1.287649183112638e-06,-1.2447276523941397e-06,-1.2032368322256737e-06,-1.1631290327551724e-06,-1.124358153636873e-06,-1.0868796313512341e-06,-1.0506503878016105e-06,-1.015628780631772e-06,-9.817745555973367e-07,-9.490488002694697e-07,-9.174138993484071e-07,-8.868334911982245e-07,-8.57272426435518e-07,-8.286967271287082e-07,-8.010735478847231e-07,-7.743711383234597e-07,-7.485588063849136e-07,-7.236068829130637e-07,-6.994866877940709e-07,-6.76170496927142e-07,-6.536315103056189e-07,-6.318438212638e-07,-6.107823867229634e-07,-5.904229983255682e-07,-5.707422545686569e-07,-5.5171753404748e-07,-5.333269695317888e-07,-5.155494225417279e-07,-4.983644591449732e-07,-4.817523268085822e-07,-4.6569393113982116e-07,-4.501708142368166e-07,-4.351651337053397e-07,-4.206596416200803e-07,-4.0663766520676603e-07,-3.9308308724672614e-07,-3.799803278137226e-07,-3.6731432628833716e-07,-3.550705242050256e-07,-3.432348482657055e-07,-3.317936942970334e-07,-3.2073391165177156e-07,-3.100427879987322e-07,-2.997080346678338e-07,-2.897177727168021e-07,-2.800605191088934e-07,-2.707251736122629e-07,-2.617010059768887e-07,-2.529776436110964e-07,-2.4454505970217255e-07,-2.3639356167004522e-07,-2.285137798985204e-07,-2.2089665735469666e-07,-2.135334387087795e-07,-2.064156603975853e-07,-1.995351411876456e-07,-1.9288397246075561e-07,-1.864545091101455e-07,-1.8023936104727412e-07,-1.7423138443106723e-07,-1.6842367356328936e-07,-1.628095529504492e-07,-1.573825696432607e-07,-1.5213648563161541e-07,-1.470652709611997e-07,-1.4216309662806736e-07,-1.3742432802832383e-07,-1.3284351835229913e-07,-1.2841540220076553e-07,-1.2413488992280008e-07,-1.1999706134302457e-07,-1.1599716021049034e-07,-1.1213058903614126e-07,-1.0839290359720977e-07,-1.0477980755263516e-07,-1.0128714800217153e-07,-9.791091037936184e-08,-9.464721406615695e-08,-9.149230756344551e-08,-8.844256454976218e-08,-8.549447949590672e-08,-8.26446639456968e-08,-7.988984224160944e-08,-7.722684797206725e-08,-7.465262008565787e-08,-7.216419978250954e-08,-6.975872673953276e-08,-6.743343611281816e-08,-6.51856552069674e-08,-6.301280025544642e-08,-6.091237381156134e-08,-5.8881961528811644e-08,-5.6919229662888426e-08,-5.502192224060565e-08,-5.318785833985373e-08,-5.1414929924664676e-08,-4.9701099125165626e-08,-4.804439596162169e-08,-4.644291629052333e-08,-4.4894819251073415e-08,-4.339832543331923e-08,-4.195171471321757e-08,-4.0553324309744454e-08,-3.920154695302713e-08,-3.789482877492034e-08,-3.6631667865716366e-08,-3.5410612386765905e-08,-3.4230258794121227e-08,-3.3089250228712785e-08,-3.198627523959274e-08,-3.092006606308928e-08,-2.9889397235027815e-08,-2.889308403641877e-08,-2.7929981272212245e-08,-2.6998981939030386e-08,-2.6099015892899757e-08,-2.5229048739028315e-08,-2.438808049953778e-08,-2.3575144503240608e-08,-2.278930638643928e-08,-2.2029662871680955e-08,-2.129534076855677e-08,-2.0585496085523403e-08,-1.9899312919680057e-08,-1.9236002513078887e-08,-1.8594802420057732e-08,-1.7974975674572846e-08,-1.7375809846509327e-08,-1.6796616153502697e-08,-1.623672890582739e-08,-1.5695504618218337e-08,-1.5172321121692534e-08,-1.4666577119459845e-08,-1.4177691187722274e-08,-1.370510144260706e-08,-1.3248264763010553e-08,-1.2806655902419806e-08,-1.237976737789026e-08,-1.1967108470845034e-08,-1.1568204894008005e-08,-1.1182598014247702e-08,-1.0809844741554997e-08,-1.0449516529842384e-08,-1.0101199265921679e-08,-9.7644926033702e-09,-9.439009518441566e-09,-9.124375865976475e-09,-8.820230046335809e-09,-8.526222339266809e-09,-8.242014903903083e-09,-7.967281112630786e-09,-7.701705106999412e-09,-7.44498157567719e-09,-7.196815532406475e-09,-6.9569216498699404e-09,-6.725024259690571e-09,-6.500856797320154e-09,-6.284161579994674e-09,-6.074689473667405e-09,-5.872199781986609e-09,-5.676459802206324e-09,-5.4872444921194585e-09,-5.304336359035489e-09,-5.12752512671355e-09,-4.956607624340137e-09,-4.79138734243989e-09,-4.631674432875599e-09,-4.47728526475899e-09,-4.328042424450729e-09,-4.18377438249351e-09,-4.044315271567456e-09,-3.909504775467809e-09,-3.779187907060333e-09,-3.6532150082813075e-09,-3.5314411950260194e-09,-3.4137264681710633e-09,-3.29993560255204e-09,-3.189937702874346e-09,-3.083606425757779e-09,-2.9808195356473277e-09,-2.8814589048131722e-09,-2.7854102913060785e-09,-2.6925632279350964e-09,-2.602811133289862e-09,-2.5160507566290846e-09,-2.4321823999251535e-09,-2.351109695819531e-09,-2.2727393855781486e-09,-2.196981430113709e-09,-2.1237486769187797e-09,-2.052957082110396e-09,-1.9845251553185506e-09,-1.9183742927531e-09,-1.8544284441368575e-09,-1.7926141127055928e-09,-1.7328603552080324e-09,-1.6750983378166495e-09,-1.6192616691945716e-09,-1.5652862894732777e-09,-1.513110026163389e-09,-1.462673038243878e-09,-1.4139172610505568e-09,-1.366786628320682e-09,-1.3212270721929542e-09,-1.2771861901406112e-09,-1.23461335599373e-09,-1.1934596089169247e-09,-1.1536776534093462e-09,-1.11522174828238e-09,-1.0780477066596461e-09,-1.0421127849546963e-09,-1.0073756828710145e-09};

  // variables to be uploaded MUST be static
  //NOTE: otherwise their value can change before retrieval
  static char *   msg = "float exp(x) results:";
  static uint32_t num_data;
  static float    data[20001];
  
  // define constants and variables
  static float dt = 0.1;
  static float V;
  V = -65;
  static float V_temp;
  static float ie = 35.80986219567645;
  static float dCaAP_count = 0;
  static float t_dCaAP;
  t_dCaAP = -200;
  static float K = 0;
  static float i_dCaAP = 0;
  static float totGE = -70;
  static float v_th = -36;
  static float refract_period = 200;
  static float AB_refract_period = 77.7;
  static float denom = -0.08547009;
  static float w = 0.2;
  static float C = -1;
  static float F;
  static float f;
  static float dV;
  static float c_denom = 0.9090909090909091;
  static float this_t = -0.05;
  static uint32_t count = 0;
  static float AB = 0;
  
  //record initial voltage then update with starting conditions
  data[0] =  V;
  F = totGE + (ie-i_dCaAP*1000);
  f = (F + C*V) * dt;
  dV = f * c_denom;
  v_temp = V + dV;
  V = v_temp;
  
  num_data = 20001;
  for (uint32_t i = 1; i < num_data; i++) {
          //record voltage
          data[i] = V;
    
          // check whether a dCaAP has been fired
          this_t = (i*dt) - (dt/2);
          if (this_t > t_dCaAP + refract_period && V > v_th) {
                  t_dCaAP = this_t;
                  K = hwexpf((V - v_th) * denom);
                  if (K > 1) {
                           K = 1;
                   }
                  dCaAP_count += 1;
          }
          
          // calculate AB using LUT
          if (this_t < t_dCaAP + AB_refract_period && dCaAP_count > 0) {
                  AB = AB_lookup[count];
                  count += 1;
                  if (count == 777) {
                          count = 0;
                  }
          }
          else {
                  AB = 0;
          }
          // update calcium current and update membrane potential
          i_dCaAP = -(AB) * w * K;
          F = totGE + (ie-(i_dCaAP*1000));
          f = (F + C*V) * dt;
          dV = f * c_denom;
          V += dV;
  }

  
